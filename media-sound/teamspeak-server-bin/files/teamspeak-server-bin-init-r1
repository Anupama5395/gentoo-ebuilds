#!/sbin/runscript
# Copyright 1999-2015 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: /var/cvsroot/gentoo-x86/media-sound/teamspeak-server-bin/files/teamspeak-server-bin-init-r1,v 1.1 2015/08/02 13:00:19 jlec Exp $

DIR="/opt/teamspeak3"
name="TeamSpeak Server"
command="${DIR}/bin/ts3server"
pidfile="/var/run/teamspeak3/server.pid"
command_background="true"

depend() {
	need net
	use mysql
}

start_pre() {
	# Ensure that ts3-server finds all custom shared objects on startup
	export LD_LIBRARY_PATH="${DIR}/lib${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}"

	# Temporary fix for EPERM bug (we still leave it here to make sure it is *really* not there)
	[[ -e /dev/shm/7gbhujb54g8z9hu43jre8 ]] && rm -f /dev/shm/7gbhujb54g8z9hu43jre8

	checkpath -d --owner teamspeak3:teamspeak3 --mode 0700 "$( dirname "${pidfile}" )"
}

start() {
	ebegin "Starting ${name}"

	start-stop-daemon --start --quiet --background \
		--pidfile "${pidfile}" --make-pidfile \
		--user "teamspeak3" --chdir "${DIR}" \
		--exec "${command}" -- \
		inifile="/etc/teamspeak3/server.conf"

	eend $?
}

restart() {
	stop
	sleep 3
	start
}
